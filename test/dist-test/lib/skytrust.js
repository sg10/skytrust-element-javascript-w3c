/*! skytrust-javascript-element - v1.0.0 - 2015-04-13
* Copyright (c) 2015 Stefan Gruber; Licensed MIT */
define("common/crypto-object",[],function(){var e=function(e){var r={},t={},o=0;this.resolve=function(){},this.reject=function(){},this.setHeader=function(e){r=JSON.parse(JSON.stringify(e))},this.getHeader=function(){return r},this.setPayload=function(e){t=JSON.parse(JSON.stringify(e))},this.getPayload=function(){return t},this.setErrorCode=function(e){o=e},this.getErrorCode=function(){return o},this.jsonSkyTrust=function(){return JSON.stringify({header:r,payload:t})},this.comObjectData=function(){return{header:r,payload:t,error:o}},this.toString=function(){return"[CryptoObject] header="+r+", payload="+t+", error="+o},e&&this.setPayload(e)};return e}),define("common/router",["require","../common/crypto-object"],function(e){var r=e("../common/crypto-object"),t=function(e){var o="";if(this.route=function(e,t,n){if(console.log("[common][router]  FROM="+e+" TO="+t),!(n instanceof r))throw new Error("Router can only transmit instances of CryptoObject");if(o.getComponent(t)===!1)throw new Error("Router, receiver: no component named "+t);if(o.getComponent(e)===!1)throw new Error("Router, sender: no component named "+e);if(!o.getComponent(t).onReceive)throw new Error("Router: onReceive() method not defined");o.getComponent(t).onReceive(n)},!(this instanceof t))throw new Error("Router called statically");o=e};return t}),define("common/component",[],function(){var e=function(){if(!(this instanceof e))throw new Error("Component called statically")};return e.prototype.send=function(e,r){console.log("[WARNING] abstract method was not overwritten"),console.log("to="+e+", cryptoObject="+r)},e.prototype.onReceive=function(e){console.log("[WARNING] abstract method was not overwritten"),console.log("cryptoObject="+e)},e}),define("common/error",["require"],function(){var e={};return e.NotYetImplementedError=function(e){Error.call(this),this.name="NotYetImplementedException",this.message=e,this.stack=(new Error).stack,this.toStringError=function(){return"Error: "+this.name+": "+this.message}},e.NotYetImplementedError.prototype=Object.create(Error.prototype),e.NoSuchProviderError=function(){Error.call(this),this.name="NoSuchProviderError",this.message="Provider does not exist.",this.stack=(new Error).stack,this.toStringError=function(){return"Error: "+this.name+": "+this.message}},e.NoSuchProviderError.prototype=Object.create(Error.prototype),e.UnauthorizedError=function(){Error.call(this),this.name="UnauthorizedError",this.message="Please authorize, no active or invalid session.",this.stack=(new Error).stack,this.toStringError=function(){return"Error: "+this.name+": "+this.message}},e.UnauthorizedError.prototype=Object.create(Error.prototype),e.KeyError=function(e){Error.call(this),this.name="KeyError",this.message="CryptoKey provided to an operation does not meet requirements"+(null!==e?":"+e:""),this.stack=(new Error).stack,this.toStringError=function(){return"Error: "+this.name+": "+this.message}},e.KeyError.prototype=Object.create(Error.prototype),e.SkyTrustError=function(e,r){Error.call(this),this.name="KeyError",this.message="CryptoKey provided to an operation does not meet requirements"+(null!==r?": "+r:""),this.code=e,this.stack=(new Error).stack,this.toStringError=function(){return"Error: "+this.name+": "+this.message}},e.SkyTrustError.prototype=Object.create(Error.prototype),e.QuotaExceededError=function(e){Error.call(this),this.name="QuotaExceededError",this.message=e,this.code=22,this.stack=(new Error).stack,this.toStringError=function(){return"Error: "+this.name+": "+this.message}},e.QuotaExceededError.prototype=Object.create(Error.prototype),e.InvalidAccessError=function(){Error.call(this),this.name="InvalidAccessError",this.message="The requested operation is not valid for the provided key.",this.code=15,this.stack=(new Error).stack,this.toStringError=function(){return"Error: "+this.name+": "+this.message}},e.InvalidAccessError.prototype=Object.create(Error.prototype),e.SyntaxError=function(){Error.call(this),this.name="SyntaxError",this.message="A required parameter was missing or out-of-range",this.code=12,this.stack=(new Error).stack,this.toStringError=function(){return"Error: "+this.name+": "+this.message}},e.SyntaxError.prototype=Object.create(Error.prototype),e.NotSupportedError=function(e){Error.call(this),this.name="NotSupportedError",this.message="This algorithm is not supported: "+e,this.code=9,this.stack=(new Error).stack,this.toStringError=function(){return"Error: "+this.name+": "+this.message}},e.NotSupportedError.prototype=Object.create(Error.prototype),e.OperationNotSupportedError=function(){Error.call(this),this.name="OperationNotSupported",this.message="SkyTrust doesn't support this operation.",this.code=9,this.stack=(new Error).stack,this.toStringError=function(){return"Error: "+this.name+": "+this.message}},e.OperationNotSupportedError.prototype=Object.create(Error.prototype),e.InvalidStateError=function(){Error.call(this),this.name="InvalidStateError",this.message="The requested operation is not valid for the current state of the provided key.",this.code=11,this.stack=(new Error).stack,this.toStringError=function(){return"Error: "+this.name+": "+this.message}},e.InvalidStateError.prototype=Object.create(Error.prototype),e.OperationError=function(){Error.call(this),this.name="OperationError",this.message="The operation failed for an operation-specific reason.",this.stack=(new Error).stack,this.toStringError=function(){return"Error: "+this.name+": "+this.message}},e.OperationError.prototype=Object.create(Error.prototype),e.UnknownError=function(){Error.call(this),this.name="UnknownError",this.message="The operation failed for an unknown transient reason (e.g. out of memory).",this.stack=(new Error).stack,this.toStringError=function(){return"Error: "+this.name+": "+this.message}},e.UnknownError.prototype=Object.create(Error.prototype),e.DataError=function(e){Error.call(this),this.name="DataError",this.message="Data provided to an operation does not meet requirements"+(null!==e?":"+e:""),this.stack=(new Error).stack,this.toStringError=function(){return"Error: "+this.name+": "+this.message}},e.DataError.prototype=Object.create(Error.prototype),e.TypeMismatchError=function(e){Error.call(this),this.name="TypeMismatchError",this.message=e,this.stack=(new Error).stack,this.toStringError=function(){return"Error: "+this.name+": "+this.message}},e.TypeMismatchError.prototype=Object.create(Error.prototype),e}),define("common/util",["require","../common/error"],function(e){var r=e("../common/error"),t={};return t.arrayBufferToBase64=function(e){for(var r="",t=new Uint8Array(e.buffer?e.buffer:e),o=t.byteLength,n=0;o>n;n++)r+=String.fromCharCode(t[n]);return window.btoa(r)},t.base64ToArrayBuffer=function(e){for(var r=window.atob(e),t=r.length,o=new Uint8Array(t),n=0;t>n;n++)o[n]=r.charCodeAt(n);return o.buffer},t.arrayBufferToBase64_array=function(e){if(!($.isArray(e)||e[0]instanceof ArrayBuffer))return[];var r=[];return $.each(e,function(e,o){r.push(t.arrayBufferToBase64(o))}),r},t.base64ToArrayBuffer_array=function(e){if(!$.isArray(e))return[];var r=[];return $.each(e,function(e,o){r.push(t.base64ToArrayBuffer(o))}),r},t.isArrayBufferView=function(e){return e&&e.buffer instanceof ArrayBuffer&&void 0!==e.byteLength},t.inArray=function(e,r){if(!r||!r.length)return!1;for(var t=e.toLowerCase(),o=0;o<r.length;o++)if(t===r[o].toLowerCase())return r[o];return!1},t.copyOf=function(e){var r;if("string"==typeof e)return""+e;if("number"==typeof e||"boolean"==typeof e)return e;if("[object Date]"===Object.prototype.toString.call(e))return r=new Date,r.setTime(e.getTime()),r;if(Array.isArray(e)){r=[];for(var o=0;o<e.length;o++)r[o]=t.copyOf(e[o]);return r}if(e instanceof ArrayBuffer)return e.slice(0);if("object"==typeof e||e instanceof Object)return $.extend(!0,{},e);throw new Error("Copying type "+typeof e+" is not supported!")},t.rejectedPromise=function(e){return new Promise(function(r,t){t(e)})},t.warningIfNotNull=function(e){$.each(e,function(e,r){null!=r&&console.warn("Parameter '"+e+"' is not used via this API. To disable this warning, set it to null.")})},t.throwNotSupportedError=function(){throw new r.OperationNotSupportedError},t}),define("common/protocol",["require","../common/util","jQuery"],function(e){var r=e("../common/util"),t=e("jQuery"),o={},n=function(e,r){var t=r.split("."),o=e;try{for(var n=0;n<t.length;n++){if(!o.hasOwnProperty(r[n]))throw new Error;o=o[r[n]]}}catch(i){throw new SkyError(0,"key '"+r+"' does not exist")}return o},i=function(e){if("[object Array]"!==Object.prototype.toString.call(e))return a(e);for(var r=[],t=0;t<e.length;t++)r.push(a(e[t]));return r},a=function(e){if(null==e||!e.keyType)return null;var r={type:e.keyType};return("handle"===e.keyType||"internalCertificate"===e.keyType)&&(r.id=e.id,r.subId=e.subId),"internalCertificate"===e.keyType&&(r.encodedCertificate=e.encodedCertificate),"wrappedKey"===e.keyType&&(r.encodedWrappedKey=e.encodedWrappedKey),"externalCertificate"===e.keyType&&(r.encodedCertificate=e.encodedCertificate),r};return o.getBlankHeader=function(){var e={type:"standardSkyTrustHeader",commandId:"",sessionId:"",path:["java-api-instance"],protocolVersion:"2.0"};return e},o.setBlankHeader=function(e){e.setHeader(o.getBlankHeader())},o.setDiscoverKeysRequest=function(e){var r={type:"discoverKeysRequest",representation:"handle"};e.setPayload&&e.setPayload(r)},o.setSessionId=function(e,r){if(e.getHeader){var t=e.getHeader();t.sessionId=r,e.setHeader(t)}else e.sessionId=r},o.getSessionId=function(e){return e.getHeader?n(e.getHeader(),"sessionId"):void 0},o.setUserPasswortAuth=function(e,r,t){var o={type:"authChallengeResponse",authInfo:{type:"UserNamePasswordAuthInfo",userName:r,passWord:t}};e.setPayload&&e.setPayload(o)},o.setEncryptRequest=function(e,t,o,n){var i=r.arrayBufferToBase64(n),s={type:"encryptRequest",encryptionKeys:[a(o)],algorithm:t,plainData:[i]};e.setPayload&&e.setPayload(s)},o.setDecryptRequest=function(e,t,o,n){var i=r.arrayBufferToBase64(n),s={type:"decryptRequest",decryptionKey:a(o),algorithm:t,encryptedData:[i]};e.setPayload&&e.setPayload(s)},o.setEncryptCMSRequest=function(e,o,n,i){var s=r.arrayBufferToBase64_array(i),c=[];t.each(n,function(e,r){c.push(a(r))});var u={type:"encryptCMSRequest",encryptionKeys:c,algorithm:o,plainData:s};e.setPayload&&e.setPayload(u)},o.setDecryptCMSRequest=function(e,t,o,n){var i=r.arrayBufferToBase64_array(n),s={type:"decryptCMSRequest",decryptionKey:a(o),encryptedCMSData:i};e.setPayload&&e.setPayload(s)},o.setSignRequest=function(e,t,o,n){var i=r.arrayBufferToBase64(n),s={type:"signRequest",signatureKey:a(o),algorithm:t,hashesToBeSigned:[i]};e.setPayload&&e.setPayload(s)},o.setGenerateWrappedKeyRequest=function(e,r,t,o,n){var s=a(o),c={type:"generateWrappedKeyRequest",encryptionKeys:i(t),keyType:r,certificateSubject:n};null!=s&&(c.signingKey=s),e.setPayload&&e.setPayload(c)},o.isAuthRequired=function(e){var r=e.getPayload();return r&&"authChallengeRequest"===r.type?!0:!1},o.getAuthTypes=function(e){for(var r=e.getPayload().authTypes,t=[],o=0;r&&o<r.length;o++)t.push(r[o].type);return t},o.getError=function(e){var r=e.getPayload();return r&&"status"===r.type?r.code:!1},o.getCommandId=function(e){return e.getHeader?e.getHeader().commandId:e.commandId},o.setCommandId=function(e,r){e.getHeader||(e.commandId=r),e.getHeader().commandId=r},o.supportedAlgorithms={encrypt:["RSA-OAEP","RSAES-PKCS1-v1_5","RSAES-RAW"],sign:["RSASSA-PKCS1-v1_5-SHA-1","RSASSA-PKCS1-v1_5-SHA-224","RSASSA-PKCS1-v1_5-SHA-256","RSASSA-PKCS1-v1_5-SHA-512"],cms:["CMS-AES-128-CBC","CMS-AES-192-CBC","CMS-AES-256-CBC","CMS-AES-128-GCM","CMS-AES-192-GCM","CMS-AES-256-GCM","CMS-AES-128-CCM","CMS-AES-192-CCM","CMS-AES-256-CCM"],wrapped:["RSA-2048","RSA-4096"]},o}),define("common/key",["require","./util"],function(e){var r=(e("./util"),function(e,t){if(!(this instanceof r))throw new Error("CryptoKey called statically");if(Object.defineProperty(this,"keyType",{value:e}),"handle"===e||"internalCertificate"===e)Object.defineProperty(this,"id",{value:t.id}),Object.defineProperty(this,"subId",{value:t.subId}),"internalCertificate"===e&&Object.defineProperty(this,"encodedCertificate",{value:t.encodedCertificate}),Object.defineProperty(this,"extractable",{value:!1});else if("wrappedKey"===e)Object.defineProperty(this,"encodedWrappedKey",{value:t.encodedWrappedKey}),Object.defineProperty(this,"encodedX509Certificate",{value:t.encodedX509Certificate}),Object.defineProperty(this,"extractable",{value:!0});else{if("externalCertificate"!==e)throw new KeyError("Invalid keyType specified: "+e);Object.defineProperty(this,"encodedCertificate",{value:t.encodedCertificate}),Object.defineProperty(this,"extractable",{value:!0})}Object.defineProperty(this,"type",{value:"secret"}),Object.defineProperty(this,"algorithm",{value:null}),Object.defineProperty(this,"usages",{value:null})});return r.prototype.toString=function(){var e="[CryptoKey] ";return"handle"===this.keyType||"encodedCertificate"===this.keyType?(e=e+"id="+this.id+", subId="+this.subId,"internalCertificate"===this.keyType&&(e=e+" certificate="+this.encodedCertificate.substr(0,8)+"...")):"wrappedKey"===this.keyType?e=e+"wrappedKey="+this.encodedWrappedKey.substr(0,3)+"..."+this.encodedWrappedKey.substr(550,7)+"...":"externalCertificate"===this.keyType&&(e=e+"certificate="+this.encodedCertificate.substr(0,3)+"..."+this.encodedCertificate.substr(550,7)+"..."),e},r}),define("w3ccrypto/receiver",["require","../common/component","../common/crypto-object","../common/protocol","../skytrust-config","../common/util","../common/error","../common/key"],function(e){var r=e("../common/component"),t=e("../common/crypto-object"),o=e("../common/protocol"),n=(e("../skytrust-config"),e("../common/util")),i=e("../common/error"),a=e("../common/key"),s=function(){var e=this,r=function(e,r){var t=e.name?e.name:e;t=(""+t).toLowerCase();var a=(""+r).toLowerCase(),s="decrypt"===a?"encrypt":a,c=o.supportedAlgorithms[s],u=n.inArray(t,c);if(!c||!u)throw new i.NotSupportedError(t);return u},s=function(o,s,c,u,d){if($.isArray(u))$.each(u,function(e,r){return r instanceof a?void 0:n.rejectedPromise(new i.KeyError("not an array"))});else if(!(u instanceof a))return n.rejectedPromise(new i.KeyError);if($.isArray(d))$.each(d,function(e,r){return r instanceof ArrayBuffer||n.isArrayBufferView(r)?void 0:n.rejectedPromise(new i.DataError("Data is not a valid ArrayBuffer/ArrayBufferView array"))});else if(!(d instanceof ArrayBuffer||n.isArrayBufferView(d)))return n.rejectedPromise(new i.DataError("Data is not a valid ArrayBuffer/ArrayBufferView"));try{c=r(c,s)}catch(p){return n.rejectedPromise(p)}return new Promise(function(r,n){var i=new t;o(i,c,u,d),i.resolve=r,i.reject=n,e.send("communication",i)})},c={encrypt:{request:function(e,r,t){return $.isArray(r)?n.rejectedPromise(new i.KeyError("Key can't be an array")):$.isArray(t)?n.rejectedPromise(new i.DataError("Data can't to be an array")):s(o.setEncryptRequest,"encrypt",e,r,n.copyOf(t))},response:function(e,r){r.encryptedData[0]&&r.encryptedData[0][0]?e.resolve(n.base64ToArrayBuffer(r.encryptedData[0][0])):e.rejected(new i.SkyTrustError(e.getErrorCode()))}},decrypt:{request:function(e,r,t){return $.isArray(r)?n.rejectedPromise(new i.KeyError("Key can't be an array")):$.isArray(t)?n.rejectedPromise(new i.DataError("Data can't to be an array")):s(o.setDecryptRequest,"decrypt",e,r,n.copyOf(t))},response:function(e,r){e.resolve(n.base64ToArrayBuffer(r.plainData[0]))}},sign:{request:function(e,r,t){return $.isArray(r)?n.rejectedPromise(new i.KeyError("Key can't be an array")):$.isArray(t)?n.rejectedPromise(new i.DataError("Data can't to be an array")):s(o.setSignRequest,"sign",e,r,n.copyOf(t))},response:function(e,r){e.resolve(n.base64ToArrayBuffer(r.signedHashes[0]))}},encryptCMS:{request:function(e,r,t){return $.isArray(r)?$.isArray(t)?s(o.setEncryptCMSRequest,"cms",e,r,n.copyOf(t)):n.rejectedPromise(new i.DataError("Data has to be an array")):n.rejectedPromise(new i.KeyError("Key has to be an array"))},response:function(e,r){e.resolve(n.base64ToArrayBuffer_array(r.encryptedCMSData))}},decryptCMS:{request:function(e,r,t){return $.isArray(r)?n.rejectedPromise(new i.KeyError("Key can't be an array")):$.isArray(t)?s(o.setDecryptCMSRequest,"cms",e,r,n.copyOf(t)):n.rejectedPromise(new i.DataError("Data has to be an array"))},response:function(e,r){e.resolve(n.base64ToArrayBuffer_array(r.plainData))}},discoverKeys:{request:function(){return new Promise(function(r,n){var i=new t;o.setDiscoverKeysRequest(i),i.resolve=r,i.reject=n,e.send("communication",i)})},response:function(e,r){for(var t=r.key,o=[],n=0;n<t.length;n++){var i={id:t[n].id,subId:t[n].subId};o.push(new a("handle",i))}e.resolve(o)}},generateWrappedKey:{request:function(i,a,s,c){var u=n.copyOf(c);try{i=r(i,"wrapped")}catch(d){return rejectedPromise(d)}return new Promise(function(r,n){var c=new t;o.setGenerateWrappedKeyRequest(c,i,a,s,u),c.resolve=r,c.reject=n,e.send("communication",c)})},response:function(e,r){var t=new a("wrappedKey",r);e.resolve(t)}},exportKey:function(e,r){return new Promise(function(t,o){r instanceof a||o(new i.KeyError(r)),r.extractable!==!0&&o(new i.InvalidAccessError),"wrapped"===e?t({encodedWrappedKey:r.encodedWrappedKey,encodedX509Certificate:r.encodedX509Certificate}):"x509"===e?t({encodedCertificate:r.encodedCertificate}):o(new Error("invalid export format"))})},importKey:function(e,r){n.copyOf(r);return new Promise(function(t,o){var n={x509:"externalCertificate",id:"handle",wrapped:"wrappedKey"};if(n.hasOwnProperty(e)){var s=new a(n[e],r);t(s)}else o(new i.NotSupportedError(e))})}};this.onReceive=function(e){console.log("[w3c   ] received at receiver component"),console.log(e);var r=o.getError(e);if(r!==!1)e.reject(new Error("SkyTrust/HTTP error code "+r));else{var t=e.getPayload(),n=t.type,i={decryptResponse:c.decrypt.response,encryptResponse:c.encrypt.response,signResponse:c.sign.response,encryptCMSResponse:c.encryptCMS.response,decryptCMSResponse:c.decryptCMS.response,discoverKeysResponse:c.discoverKeys.response,generateWrappedKeyResponse:c.generateWrappedKey.response};try{i[n](e,t)}catch(a){e.reject(a)}}},this.operation={encrypt:c.encrypt.request,decrypt:c.decrypt.request,sign:c.sign.request,encryptCMS:c.encryptCMS.request,decryptCMS:c.decryptCMS.request,discoverKeys:c.discoverKeys.request,generateWrappedKey:c.generateWrappedKey.request,exportKey:c.exportKey,importKey:c.importKey}};return s.prototype=Object.create(r),s}),define("common/com-object",["require","jQuery"],function(e){var r=(e("jQuery"),function(){this.requestID=-1,this.type=null,this.data={}});return r}),define("w3ccrypto/communication",["require","../common/component","../common/protocol","../common/com-object"],function(e){var r=e("../common/component"),t=e("../common/protocol"),o=e("../common/com-object"),n=function(e){var r="",i=this,a={},s=!1,c=function(){console.log("[w3c   ] init post message listener"),window.addEventListener("message",l,!1)},u=function(e){var r=new o;r.type="request";var t="";do t=Math.round(1e6*Math.random());while(a.hasOwnProperty(t));return r.requestID=t,r.data=e.comObjectData(),a[t]=e,r},d=function(e){var t=document.getElementById(r);if(s===!1)var o=window.setInterval(function(){s===!0&&(window.clearInterval(o),t.contentWindow.postMessage(e,"*")),console.log("[w3c   ] request "+e.requestID+", waiting for IFrame to be loaded")},500);else console.log("[w3c   ] sending request "+e.requestID+" to IFrame"),t.contentWindow.postMessage(e,"*");console.log("[w3c   ] pending requests: "+Object.keys(a).length)},p=function(e){console.log("[w3c   ] data to send: "),console.log(e);var r=u(e);d(r)},f=function(e){var r=a[e];return a[e]&&delete a[e],r},y=function(e){console.log("[w3c   ] sending post message to iframe ..."),p(e)},l=function(e){console.log("[w3c   ] received post message ..."),console.log("[w3c   ] postMessage origin: "+e.origin),console.log("[w3c   ] postMessage data:"),console.log(e.data);var t=e.data;if(!t.type)return void reject(new Error("Invalid response from IFrame"));if("hello"===t.type)return console.log("[w3c   ] recevied 'alive-message': IFrame element loaded"),void(s=!0);if("request"===t.type){var o=t.data;if(!t.requestID||!t.data)throw new Error("Invalid response from IFrame");var n=f(t.requestID);if(!n)throw new Error("no matching request with ID '"+o.requestID+"' found!");n.setPayload(o.payload),n.setHeader(o.header),i.send("receiver",n)}else"show-auth"===t.type&&$("#"+r).parent()!==$("body")?$("#"+r).parent().show():"hide-auth"===t.type&&$("#"+r).parent()!==$("body")&&$("#"+r).parent().hide()};if(this.onReceive=function(e){console.log("[w3c   ] received at communication component"),t.setBlankHeader(e),y(e)},!(this instanceof n))throw new Error("Communication called statically");r=e,c()};return n.prototype=Object.create(r),n}),define("w3ccrypto/element",["require","../common/router","../w3ccrypto/receiver","../w3ccrypto/communication","../skytrust-config","jQuery"],function(e){var r=e("../common/router"),t=e("../w3ccrypto/receiver"),o=e("../w3ccrypto/communication"),n=e("../skytrust-config"),i=e("jQuery"),a=function(){var e={},s=new r(this),c="skytrust-iframe",u=n.iFrameSrc,d=function(r,t){return e.hasOwnProperty(r)?!1:(e[r]=t,void(t.send=function(e,t){s.route(r,e,t)}))},p=function(){var e=i("#"+n.iFrameContainerID),r=i('<iframe src="about:blank" id="skytrust-iframe">');e.length?e.append(r):i("body").append(r),i(document).ready(function(){console.log("[w3c   ] loading iframe target ..."),i("#"+c).attr("src",u)})};if(this.operation={},this.getComponent=function(r){return e.hasOwnProperty(r)?e[r]:!1},!(this instanceof a))throw new Error("Element called statically");p(),d("receiver",new t),d("communication",new o(c)),this.operation=e.receiver.operation};return a}),define("w3ccrypto/key-store",["require","../skytrust-config","./provider"],function(e){var r=function(){if(!(this instanceof r))throw new Error("KeyStore called statically");var t=this,o=null,n=null,i=e("../skytrust-config").keyStore.cachingTime,a=null,s=!0,c=function(){return new Promise(function(e,r){s===!0?n.extended.listKeys().then(function(r){o={},$.each(r,function(e,r){o[r.id+"-"+r.subId]=r}),s=!1,window.clearTimeout(a),a=window.setTimeout(function(){console.log("KeyStore cache timeout"),s=!0},i),e()})["catch"](r):e()})};t.open=function(){return new Promise(function(r,o){var i=e("./provider");n=new i,n||o(new Error("No SkyTrust Crypto provider")),c().then(function(){r(t)})["catch"](o)})},t.saveKey=function(){return new Promise(function(e,r){r(new Error("SkyTrust key store does not support saving keys"))})},t.getKey=function(e){return new Promise(function(r,t){o||t(new Error("KeyStore is not open.")),c().then(function(){"handle"===e?o.hasOwnKey(e)?r(o[e]):t(new Error("no key with handle")):t("co"===e?new Error("not yet implemented"):new Error("propertyName '"+e+"' not supported"))})["catch"](t)})},t.listKeys=function(){return new Promise(function(e,r){o||r(new Error("KeyStore is not open.")),c().then(function(){var r=[];$.each(o,function(e,t){r.push(t)}),e(r)})["catch"](r)})},t.close=function(){return new Promise(function(e){o={},e()})}};return r}),define("w3ccrypto/provider",["require","../w3ccrypto/element","../common/error","../common/key","../common/util","../w3ccrypto/key-store"],function(e){var r=e("../w3ccrypto/element"),t=(e("../common/error"),e("../common/key")),o=e("../common/util"),n=e("../w3ccrypto/key-store"),i=null,a=function(){null===i&&(i=new r),this.subtle={},this.extended={},this.subtle.CryptoKey=t,this.subtle.encrypt=function(e,r,t){return i.operation.encrypt(e,r,t)},this.subtle.decrypt=function(e,r,t){return i.operation.decrypt(e,r,t)},this.subtle.sign=function(e,r,t){return i.operation.sign(e,r,t)},this.subtle.generateKey=function(e,r,t,n,a,s){return o.warningIfNotNull({extractable:r,keyUsages:t}),i.operation.generateWrappedKey(e,n,a,s)},this.subtle.exportKey=function(e,r){return i.operation.exportKey(e,r)},this.subtle.importKey=function(e,r,t,n,a){return o.warningIfNotNull({algorithm:t,extractable:n,keyUsages:a}),i.operation.importKey(e,r)},this.subtle.deriveKey=o.throwNotSupportedError,this.subtle.deriveBits=o.throwNotSupportedError,this.subtle.verify=o.throwNotSupportedError,this.subtle.digest=o.throwNotSupportedError,this.subtle.wrapKey=o.throwNotSupportedError,this.subtle.unwrapKey=o.throwNotSupportedError,this.extended.KeyStore=n,this.extended.listKeys=function(){return i.operation.discoverKeys()},this.extended.encryptCMS=function(e,r,t){return i.operation.encryptCMS(e,r,t)},this.extended.decryptCMS=function(e,r,t){return i.operation.decryptCMS(e,r,t)}};return a}),define("w3ccrypto/providerDef",["require","../w3ccrypto/provider","../common/error"],function(e){var r=e("../w3ccrypto/provider"),t=e("../common/error"),o=function(e){switch(e){case"w3c":return window.crypto||window.msCrypto;case"SkyTrust":return new r;default:throw new t.NoSuchProviderError}};return{getCryptoProviderByName:o}}),define("iframe/receiver",["require","../common/component","../common/crypto-object","../common/com-object"],function(e){var r=e("../common/component"),t=e("../common/crypto-object"),o=e("../common/com-object"),n=function(){var e=this,r=null,n=function(){var e=new o;e.type="hello",window.parent.postMessage(e,"*")},i=function(){console.log("[iframe] init post message listener"),window.addEventListener("message",a,!1),n()},a=function(n){console.log("[iframe] received post message ..."),console.log("[iframe] postMessage origin: "+n.origin),r=n.source;var i=n.data;if(console.log("[iframe] data received post message"),"request"!==i.type||!i.data||!i.data.payload||!i.data.header)throw console.log(i),console.log(i.data),console.log(i.data.payload),console.log(i.data.header),console.log(i.data.type),new Error("invalid data received from top-level element");var a=i.requestID,s=new t(i.data.payload);s.setHeader(i.data.header),s.resolve=function(){console.log("[iframe] sending post message back ...");var e=new o;e.type="request",e.data=s.comObjectData(),e.requestID=a,r.postMessage(e,"*")},s.reject=function(e){console.log("[iframe] sending post message back ..."),s.error=e;var t=new o;t.type="request",t.data=s.comObjectData(),t.requestID=a,r.postMessage(t,"*")},e.send("communication",s)};this.onReceive=function(e){console.log("[iframe] received at receiver component"),e.resolve()},this.sendShowAuth=function(){var e=new o;e.type="show-auth",r.postMessage(e,"*")},this.sendHideAuth=function(){var e=new o;e.type="hide-auth",r.postMessage(e,"*")},i()};return n.prototype=Object.create(r),n}),define("iframe/authentication",["require","jQuery","../skytrust-config","../common/component","../common/protocol"],function(e){var r=e("jQuery"),t=e("../skytrust-config"),o=e("../common/component"),n=e("../common/protocol"),i=function(e){var o=this,a=null,s=!1,c=function(){var e=[],r=this;r.enqueue=function(r){e.push(r)},r.dequeue=function(){if(0!==e.length){var r=e.slice(0,1)[0];return e=e.slice(1,e.length),r}return null},this.length=function(){return e.length}},u=function(){var t=a.dequeue();null!==t&&(s=!0,r("#loginform").submit(t,d),console.log("SHOW"),e.parentAuthHandler.show())},d=function(i){var c=i.data;r("#loginserver").val(t.server);var d=r("#loginusername").val(),p=r("#loginpassword").val();n.setUserPasswortAuth(c,d,p),console.log("[iframe] cryptoObject after auth"),console.log(c),r("#loginform").off("submit"),console.log("hide"),e.parentAuthHandler.hide(),o.send("communication",c),a.length()>0?u():s=!1};if(this.onReceive=function(e){console.log("[iframe] received at authentication component"),a.enqueue(e),console.log("[iframe] queue length: "+a.length()),s===!1&&u()},!(this instanceof i))throw Error("Authentication called statically");a=new c};return i.prototype=Object.create(o),i}),define("iframe/communication",["require","../common/component","../skytrust-config","../common/protocol"],function(e){var r=e("../common/component"),t=e("../skytrust-config"),o=e("../common/protocol"),n=function(){var e="",r=this,n=function(e){var o=e.jsonSkyTrust();$.ajax({url:t.server,method:"post",dataType:"json",processData:!1,contentType:"application/json",data:o}).done(function(r){i(r,e,o)}).fail(function(t,o,n){console.log("[iframe] request error "+n),e.setErrorCode(t.status),r.send("receiver",e)})},i=function(t,n){console.log("[iframe] ajax response received");var i=n;i.setHeader(t.header),i.setPayload(t.payload);var a=i.getHeader().sessionId;if(e!==a&&(console.log("[iframe] setting session ID: "+a),e=a),console.log("[iframe] error code:"+o.getError(i)),o.isAuthRequired(i)){var s=o.getAuthTypes(i);$.inArray("authChallengeRequest",s)&&r.send("authentication",i)}else r.send("receiver",n)};this.onReceive=function(r){if(console.log("[iframe] received at communication component"),null===r.getHeader()){var t=o.getBlankHeader();console.log("[iframe] header was blank, setting new header"),r.setHeader(t)}o.setSessionId(r,e),n(r)}};return n.prototype=Object.create(r),n}),define("iframe/element",["require","../common/router","../iframe/receiver","../iframe/authentication","../iframe/communication","jQuery","../skytrust-config"],function(e){var r=e("../common/router"),t=e("../iframe/receiver"),o=e("../iframe/authentication"),n=e("../iframe/communication"),i=e("jQuery"),a=e("../skytrust-config"),s=function(){var e=null,c={},u=function(r,t){return c.hasOwnProperty(r)?!1:(c[r]=t,void(t.send=function(t,o){e.route(r,t,o)}))};if(this.operation=null,this.getComponent=function(e){return c.hasOwnProperty(e)?c[e]:!1},!(this instanceof s))throw new Error("Element called statically");e=new r(this),u("receiver",new t),u("authentication",new o(this)),u("communication",new n),this.parentAuthHandler={show:c.receiver.sendShowAuth,hide:c.receiver.sendHideAuth},i("#loginserver").val(a.server)};return s}),define("external/x509-engelke",["require"],function(){function e(e){for(var t=window.atob(e),o=new Uint8Array(t.length),n=0;n<t.length;n++)o[n]=t.charCodeAt(n);return r(o)}function r(e){var r=d(e);if(0!==r.cls||16!==r.tag||!r.structured)throw new Error("This can't be an X.509 certificate. Wrong data type.");var o={asn1:r},n=t(r.contents);if(3!==n.length)throw new Error("Certificate contains more than the three specified children.");return o.tbsCertificate=s(n[0]),o.signatureAlgorithm=p(n[1]),o.signatureValue=i(n[2]),o}function t(e){for(var r=new Array,t=0;t<e.length;){var o=d(e.subarray(t));r.push(o),t+=o.byteLength}return r}function o(e){return{unusedBits:e[0],bytes:e.subarray(1)}}function n(e){if(0!==e.cls||16!==e.tag||!e.structured)throw new Error("Bad algorithm identifier. Not a SEQUENCE.");var r={asn1:e},o=t(e.contents);if(o.length>2)throw new Error("Bad algorithm identifier. Contains too many child objects.");var n=o[0];if(0!==n.cls||6!==n.tag||n.structured)throw new Error("Bad algorithm identifier. Does not begin with an OBJECT IDENTIFIER.");return r.algorithm=a(n.contents),r.parameters=2===o.length?{asn1:o[1]}:null,r}function i(e){if(0!==e.cls||3!==e.tag||e.structured)throw new Error("Bad signature value. Not a BIT STRING.");var r={asn1:e};return r.bits=o(e.contents),r}function a(e){for(var r=Math.floor(e[0]/40)+"."+e[0]%40,t=1;t<e.length;){for(var o=0;e[t]>=128;)o=128*o+(127&e[t]),t+=1;o=128*o+e[t],t+=1,r+="."+o}return r}function s(e){if(0!==e.cls||16!==e.tag||!e.structured)throw new Error("This can't be a TBSCertificate. Wrong data type.");var r={asn1:e},o=t(e.contents);if(o.length<7)throw new Error("Bad TBS Certificate. There are fewer than the seven required children.");return r.version=o[0],r.serialNumber=o[1],r.signature=n(o[2]),r.issuer=o[3],r.validity=o[4],r.subject=o[5],r.subjectPublicKeyInfo=u(o[6]),r}function c(e){if(0!==e.cls||16!==e.tag||!e.structured)throw new Error("Bad SPKI. Not a SEQUENCE.");var r=t(e.contents),o=[];console.log("pieces: "+r.length);for(var n=0;n<r.length;n++){var i=t(r[n]),a=[];console.log("pieces2: "+i.length);for(var s=0;s<i.length&&i[s].contents;s++)a.push(i[s]);o.push(a)}return o}function u(e){if(0!==e.cls||16!==e.tag||!e.structured)throw new Error("Bad SPKI. Not a SEQUENCE.");
var r={asn1:e},i=t(e.contents);if(2!==i.length)throw new Error("Bad SubjectPublicKeyInfo. Wrong number of child objects.");return r.algorithm=n(i[0]),r.bits=o(i[1].contents),r}function d(e){"use strict";function r(){var r=(192&e[a])/64;return r}function t(){var r=32===(32&e[0]);return r}function o(){var r=31&e[0];if(a+=1,31===r){for(r=0;e[a]>=128;)r=128*r+e[a]-128,a+=1;r=128*r+e[a]-128,a+=1}return r}function n(){var r=0;if(e[a]<128)r=e[a],a+=1;else{var t=127&e[a];a+=1,r=0;for(var o=0;t>o;o++)r=256*r+e[a],a+=1}return r}var i={},a=0;i.cls=r(),i.structured=t(),i.tag=o();var s=n();if(128===s){for(s=0;0!==e[a+s]||0!==e[a+s+1];)s+=1;i.byteLength=a+s+2,i.contents=e.subarray(a,a+s)}else i.byteLength=a+s,i.contents=e.subarray(a,i.byteLength);return i.raw=e.subarray(0,i.byteLength),i}var p=n;return{decodeAndParseCertificate:e,parseCertificate:r,berListToJavaScript:t,berBitStringValue:o,parseAlgorithmIdentifier:n,parseSignatureValue:i,berObjectIdentifierValue:a,parseTBSCertificate:s,parseSubject:c,parseSubjectPublicKeyInfo:u,berToJavaScript:d}}),requirejs.config({paths:{jQuery:"https://code.jquery.com/jquery-1.11.2.min"},shim:{jQuery:{exports:"$"}}}),requirejs(["jQuery","skytrust-config","w3ccrypto/providerDef","iframe/element","w3ccrypto/provider","external/x509-engelke"],function(e,r,t,o,n,i){window.x509=i,cert="MIIDrjCCApagAwIBAgIDC9LlMA0GCSqGSIb3DQEBCwUAMGwxJDAiBgNVBAsTG0RlbW8gQ2VydGlmaWNhdGUgVUlEIDMzQjI3NTELMAkGA1UEBhMCQVQxETAPBgNVBAoTCFNreVRydXN0MSQwIgYDVQQDExtJbnRlcm1lZGlhdGUvMTIgQ2VydGlmaWNhdGUwHhcNMTUwMTI2MTE1NzIwWhcNMjAxMjI2MTE1NzIwWjBlMSQwIgYDVQQLExtEZW1vIENlcnRpZmljYXRlIFVJRCAzM0IyNzUxCzAJBgNVBAYTAkFUMREwDwYDVQQKEwhTa3lUcnVzdDEdMBsGA1UEAxMUTGVhZi8xMjIgQ2VydGlmaWNhdGUwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCFQshAg5KuuXzatFZPa2mo75/PLK70xS9ojo6FZdoX9WLe36nxNIhrDng/o5kIrwJDUJvN1N3+1le5U/WOgdHmxLHVJPDyJg3Ip2RhOb9LTCAa4gKNHTmW/sQI1k3QeDf1NzTcE2upT+ev+RyhnhmXBQWnUpD70c8pUy1TeZfoozVs6wBMsWW68CLxNwbwnand8EwmXE2icJGc7AM3y3xX4O5QRRayx+D4joMryRcdmliC4xHrn0YU0FKgQH/23WEsrzJsEBYXDhVrmPglIs2C6yxa5cFT/EJ8iAJ8/FeaHBzr2dP+eNLi8NbYX5ToZCXV0LalJpNLCzFMoK4EvufNAgMBAAGjYDBeMA4GA1UdDwEB/wQEAwIE8DAMBgNVHRMBAf8EAjAAMB8GA1UdIwQYMBaAFJQsTxmxLUqoPloohBwfW0mD1NAeMB0GA1UdDgQWBBRJ8LERKtqZlTWAC/JLfBf6BxcqKDANBgkqhkiG9w0BAQsFAAOCAQEAg9GP7RqL2j/11vNhn7dhhCfkJPSy/IWp6RZUkzQsMDwhwruFsCtuYRBabQqDumioHidFwvsRLcK+nxHkmiNMQq2dzWnxeMYXlXFwRDw4BHT8MPksNxypfjVB5WSKU0hRXiNIad8SxPBhlpMddjV4Q5TVGqqZ+2577UlAaruemiP6ELqJK9OQXjHcwrO4O7XXsGW6YCbu9IEJFCc4b/SDMTlDusw6cPB7jbHfVv5hkJL5FPV0aNqX81g81bUFhBSnhwgZMz/kwFjG/HSx/U3v5qIoh3i4bJnF7mImN60o+gZvQOKadUCOHme+q61T3sbOs5tHhRctJ+yL4kW+aTtz2w==","undefined"!=typeof ___skytrust_javascript_iframe___?(console.log("[iframe] initializing SkyTrust"),new o):(console.log("[w3c   ] initializing SkyTrust: window.getCryptoProviderByName()"),window.getCryptoProviderByName=t.getCryptoProviderByName,console.log("[w3c   ] onCryptoProviderLoad() callbacks"),e.isArray(window._cryptoProviderListenerFunctions)&&e.each(window._cryptoProviderListenerFunctions,function(e,r){r()}),delete window._cryptoProviderListenerFunctions)}),define("skytrust",function(){});